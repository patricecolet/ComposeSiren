message(">>>>>>>>>> CPACK PRE BUILD SCRIPT >>>>>>>>>>>")

message("${CPACK_TEMPORARY_INSTALL_DIRECTORY}")

if(WIN32)

  # remove all .ico files generated by juce's cmake scripts that somehow get
  # copied into CPACK_TEMPORARY_INSTALL_DIRECTORY during the installation
  # process (todo: find why this happens and implement a simpler and more
  # elegant way to get around it)

  file(GLOB_RECURSE MY_FILES "${CPACK_TEMPORARY_INSTALL_DIRECTORY}/**/*.ico")
  file(REMOVE ${MY_FILES})

elseif(APPLE)

  # do the same for icns files on mac, but first force-copy the one in
  # standalone that didn't make into the bundle for some reason

  # file(GLOB_RECURSE MY_FILES LIST_DIRECTORIES true "${CPACK_TEMPORARY_INSTALL_DIRECTORY}/**/@BaseTargetName@.app")
  # list(FILTER MY_FILES INCLUDE REGEX "^.*(/@BaseTargetName@.app)$")
  # list(LENGTH MY_FILES MY_FILES_LENGTH)
  # message(STATUS ${MY_FILES_LENGTH})
  # list(GET MY_FILES 0 MY_FILE)
  # cmake_path(GET MY_FILE PARENT_PATH STANDALONE_FOLDER)
  # message("${STANDALONE_FOLDER}")
  # execute_process(
  #   COMMAND ${CMAKE_COMMAND} -E copy
  #   ${STANDALONE_FOLDER}/Icon.icns
  #   ${STANDALONE_FOLDER}/@BaseTargetName@.app/Contents/Resources/Icon.icns
  # )
  
  # we also need to sign the binaries here instead of target post build step

  # set(EXTENSIONS "component;vst;vst3;app")
  # foreach(EXT ${EXTENSIONS})
  #   file(GLOB_RECURSE MY_FILES LIST_DIRECTORIES true "${CPACK_TEMPORARY_INSTALL_DIRECTORY}/**/*.${EXT}")
  #   list(FILTER MY_FILES INCLUDE REGEX "^.*(/@BaseTargetName@.${EXT})$")
  #   # message("${MY_FILES}")
  #   foreach(FILE ${MY_FILES})
  #     execute_process(
  #       COMMAND codesign
  #       -s "@APPLE_DEVELOPER_ID_APPLICATION@"
  #       -f "${FILE}"
  #       --options runtime
  #       --timestamp --deep
  #       COMMAND ${CMAKE_COMMAND} -E echo ">>>>> @BaseTargetName@.${EXT} signed in ${FILE}"
  #     )
  #   endforeach()
  # endforeach()

  # file(GLOB_RECURSE MY_FILES "${CPACK_TEMPORARY_INSTALL_DIRECTORY}/**/*.icns")
  # file(REMOVE ${MY_FILES})

endif()

